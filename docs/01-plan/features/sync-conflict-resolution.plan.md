# [Plan] 실시간 동기화 충돌 해결 및 데이터 병합 (v3.7)

## 1. 개요
- **기능명**: 다중 기기 충돌 방지 및 지능형 데이터 병합
- **목표**: 여러 기기에서 동시 작업 시 발생하는 데이터 덮어쓰기 문제를 근본적으로 해결하고, 충돌 발생 시 데이터를 안전하게 병합하는 기능을 제공함.
- **주요 기능**:
    1. **낙관적 잠금 (Optimistic Locking)**: 클라우드 업로드 전 서버의 `updated_at`을 확인하여 내가 마지막으로 본 버전보다 새 버전이 있으면 업로드를 차단.
    2. **실시간 변경 감지 (Supabase Realtime)**: 다른 기기에서 백업이 완료되는 즉시 현재 기기에 알림을 주어 2분 폴링 대기 시간을 제거.
    3. **지능형 병합 (Smart Merge)**: 로컬 데이터와 클라우드 데이터가 충돌할 경우, 날짜별/항목별로 변경 사항을 병합하여 데이터 손실 최소화.
    4. **충돌 해결 UI**: 충돌 상황을 사용자에게 알리고 '병합', '덮어쓰기', '취소' 중 선택할 수 있는 모달 제공.

## 2. 사용자 스토리
- "노트북에서 일지를 쓰다가 저장하지 않고 태블릿을 켰을 때, 노트북의 자동 저장이 태블릿의 내용을 덮어버리지 않았으면 좋겠어."
- "두 기기에서 각각 다른 날짜의 일지를 썼다면, 자동으로 두 내용이 합쳐져서 클라우드에 저장되길 원해."

## 3. 상세 요구사항
### 3.1 낙관적 잠금 구현
- `uploadData` 함수 실행 시 먼저 서버에서 `updated_at`을 조회.
- `local.lastSyncTime < remote.updated_at` 일 경우 업로드 중단 및 충돌 상태(Conflict) 활성화.

### 3.2 실시간 채널 구독
- Supabase Realtime을 사용하여 `user_journal_data` 테이블의 변경사항 구독.
- 변경 감지 시 즉시 `checkRemoteVersion` 실행하여 사용자에게 알림.

### 3.3 병합 로직 (Merge Utility)
- `localStorageService`에 `mergeAppData` 함수 추가.
- 학급 정보, 학생 목록, 날짜별 기록(DailyRecord), 할 일(Todo)을 ID/날짜 기준으로 병합.
- `DailyRecord`의 경우 내용이 더 긴 쪽을 우선하거나, 수정 시간이 있다면 최신본 우선.

### 3.4 충돌 모달 UI
- 충돌 시 자동 백업을 일시 중지하고 사용자에게 경고.
- "병합(권장)", "서버 덮어쓰기(로컬 삭제)", "로컬 강제 업로드(서버 덮어쓰기)" 옵션 제공.

## 4. 제약 사항 및 고려 사항
- **암호화 데이터**: 클라우드 데이터는 암호화되어 있으므로 병합은 복호화 후 로컬에서 수행해야 함.
- **병합 복잡도**: 동일한 날짜의 동일한 항목을 동시에 수정했을 경우의 충돌은 완벽한 해결이 어려우므로 사용자에게 확인 필요.

## 5. 성공 기준
- [ ] 기기 A에서 저장 후 기기 B에서 수정 시, 기기 B의 자동 저장이 차단되고 충돌 알림이 뜸.
- [ ] 기기 A에서 2월 1일 일지를 쓰고, 기기 B에서 2월 2일 일지를 썼을 때 '병합'을 통해 두 날짜의 데이터가 모두 보존됨.
- [ ] 실시간으로 다른 기기의 백업 여부가 5초 내로 반영됨.
